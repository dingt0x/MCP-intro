<!DOCTYPE html>
<html>
<head>
    <title>AI Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <style>
        /* åŸºç¡€å¸ƒå±€ */
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 900px; margin: 20px auto; background: #f0f2f5; padding: 0 20px; }
        #chat-box { height: 500px; border: 1px solid #ddd; overflow-y: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .msg-container { margin-bottom: 20px; display: flex; flex-direction: column; }
        .user { align-items: flex-end; }
        .ai { align-items: flex-start; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; }
        .user .bubble { background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .ai .bubble { background: #f1f0f0; color: #333; border-bottom-left-radius: 2px; position: relative; }

        /* ğŸ’¡ è¿™æ˜¯ä½ åˆšåˆšè¦åŠ çš„æ—¥å¿—åˆ—è¡¨æ ·å¼ */
        .action-log-container {
            width: 80%;
            font-size: 12px;
            background: #e9ecef;
            border-left: 4px solid #007bff;
            margin: 0 0 8px 5px;
            padding: 8px 12px;
            border-radius: 4px;
            color: #495057;
            display: none; /* é»˜è®¤éšè—ï¼Œæœ‰æ—¥å¿—æ—¶ç”± JS å¼€å¯ */
        }
        .log-item { margin: 3px 0; font-family: 'Consolas', 'Monaco', monospace; }
        .log-time { color: #adb5bd; margin-right: 8px; font-weight: bold; }

        /* Markdown é€‚é… */
        .markdown-body { font-size: 14px; background: transparent !important; }

        /* è¾“å…¥åŒº */
        #input-area { display: flex; gap: 10px; margin-top: 15px; }
        input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; outline: none; }
        button { padding: 10px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
<h2>ğŸš€ AI DevOps Agent <small>(Level 3 + MCP)</small></h2>
<div id="chat-box"></div>
<div id="input-area">
    <input type="text" id="user-input" placeholder="è¯·å°½æƒ…æé—®å§" ononkeydown="if(event.keyCode==13) sendMessage()">
    <button onclick="sendMessage()">å‘é€</button>
</div>


<script>
    // é…ç½® marked é€‰é¡¹
    marked.setOptions({
        breaks: true, // æ”¯æŒæ¢è¡Œ
        gfm: true     // å¼€å¯ GitHub é£æ ¼
    });
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const box = document.getElementById('chat-box');
        if (!input.value) return;

        const userText = input.value;
        box.innerHTML += `<div class="msg-container user"><div class="bubble">${userText}</div></div>`;
        input.value = '';

        const aiMsgId = 'ai-' + Date.now();
        // ğŸ’¡ é‡ç‚¹ï¼šå¢åŠ ä¸€ä¸ª log-list å®¹å™¨
        box.innerHTML += `
        <div class="msg-container ai">
            <div id="${aiMsgId}-logs" class="action-log-container" style="display:none;"></div>
            <div id="${aiMsgId}" class="bubble markdown-body">æ­£åœ¨æ€è€ƒ...</div>
        </div>`;

        const aiBubble = document.getElementById(aiMsgId);
        const logList = document.getElementById(`${aiMsgId}-logs`);
        let fullMarkdown = "";

        const response = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: userText})
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (!line.startsWith('data: ')) continue;
                const data = JSON.parse(line.slice(6));

                if (data.type === 'status') {
                    // ğŸ’¡ çŠ¶æ€å¤„ç†ï¼šæ˜¾ç¤ºæ—¥å¿—é¢æ¿ï¼Œå¹¶è¿½åŠ ä¸€æ¡è®°å½•
                    logList.style.display = 'block';
                    const now = new Date().toLocaleTimeString();
                    logList.innerHTML += `<div class="log-item"><span class="log-time">[${now}]</span>${data.content}</div>`;
                    box.scrollTop = box.scrollHeight;
                } else if (data.type === 'text') {
                    if (fullMarkdown === "") aiBubble.innerText = "";
                    fullMarkdown += data.content;
                    aiBubble.innerHTML = DOMPurify.sanitize(marked.parse(fullMarkdown));
                    box.scrollTop = box.scrollHeight;
                }
            }
        }
    }
</script>
</body>
</html>