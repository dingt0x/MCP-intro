<!DOCTYPE html>
<html>
<head>
    <title>AI Demo </title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 900px; margin: 20px auto; background: #f0f2f5; }
        #chat-box { height: 500px; border: 1px solid #ddd; overflow-y: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
        .msg-container { margin-bottom: 20px; display: flex; flex-direction: column; }
        .user { align-items: flex-end; }
        .ai { align-items: flex-start; }

        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; }
        .user .bubble { background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .ai .bubble { background: #f1f0f0; color: #333; border-bottom-left-radius: 2px; }

        /* é‡ç‚¹ï¼šMarkdown æ ·å¼é€‚é… */
        .markdown-body { font-size: 14px; background: transparent !important; }
        pre { background: #272822 !important; color: white; padding: 10px; border-radius: 5px; overflow-x: auto; }
        code { font-family: 'Consolas', monospace; }

        #input-area { display: flex; gap: 10px; margin-top: 15px; }
        input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; outline: none; }
        button { padding: 10px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
<h2>ğŸš€ AI Chat Demo <small>(Level 0 - Once)</small></h2>
<div id="chat-box"></div>
<div id="input-area">
    <input type="text" id="user-input" placeholder="ç»™æˆ‘æ‰“æ‹›å‘¼å§ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰è®°å¿†å“¦ã€‚" ononkeydown="if(event.keyCode==13) sendMessage()">
    <button onclick="sendMessage()">å‘é€</button>
</div>

<script>
    // é…ç½® marked é€‰é¡¹
    marked.setOptions({
        breaks: true, // æ”¯æŒæ¢è¡Œ
        gfm: true     // å¼€å¯ GitHub é£æ ¼
    });

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const box = document.getElementById('chat-box');
        if (!input.value) return;

        const userText = input.value;
        box.innerHTML += `
                <div class="msg-container user">
                    <div class="bubble">${userText}</div>
                </div>`;

        input.value = '';
        box.scrollTop = box.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: userText})
            });

            const data = await response.json();

            // 2. è§£æ AI è¿”å›çš„ Markdown
            const rawAnswer = data.answer;
            const htmlAnswer = DOMPurify.sanitize(marked.parse(rawAnswer));

            // æ˜¾ç¤ºè§£æåçš„ AI æ¶ˆæ¯
            box.innerHTML += `
                    <div class="msg-container ai">
                        <div class="bubble markdown-body">${htmlAnswer}</div>
                    </div>`;

            box.scrollTop = box.scrollHeight;
        } catch (e) {
            console.error("è¯·æ±‚å¤±è´¥:", e);
            box.innerHTML += `<div class="msg-container ai"><div class="bubble" style="color:red">ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•</div></div>`;
        }
    }
</script>
</body>
</html>